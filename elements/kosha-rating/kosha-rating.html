<link rel="import" href="../../bower_components/core-ajax/core-xhr.html">
<link rel="import" href="../../bower_components/core-icons/core-icons.html">

<polymer-element name="kosha-rating" attributes="restaurant">
  <template>
    <link rel="stylesheet" href="kosha-rating.css">
    <core-xhr id="xhr"></core-xhr>
    <div>
      <template repeat="{{i in ratings}}">
        <core-icon
            icon="grade"
            class="{{i <= index ? filled : 'empty'}}"
            on-mouseenter={{onMouseEnter}}
            on-mouseleave={{onMouseLeave}}
            on-tap={{onTap}}>
        </core-icon>
      </template>
    </div>
  </template>
  <script>
    Polymer('kosha-rating', {
      index: 0, // [0, 4].
      filled: 'filled-system',
      ratingToIndex: function(rating) {
        return Math.round(rating) - 1;
      },
      indexToRating: function(index) {
        return index + 1;
      },
      initParams: function() {
        this.index = this.ratingToIndex(this.restaurant.rating);
        this.filled = this.restaurant.user_rated ? 'filled-user' : 'filled-system';
      },
      created: function() {
        // Initialize arrays and objects.
        this.restaurant = {};
        this.ratings = [];
      },
      ready: function() {
        for (var i = 0; i < 5; ++i) {
          this.ratings.push(i);
        }
        this.initParams();
      },
      onMouseEnter: function(event, detail, sender) {
        this.index = event.target.templateInstance.model.i;
        this.filled = 'filled-user';
      },
      onMouseLeave: function(event, detail, sender) {
        this.initParams();
      },
      onTap: function(event, detail, sender) {
        this.restaurant.rating = this.indexToRating(event.target.templateInstance.model.i);
        this.restaurant.user_rated = true;
        this.initParams();

        // Send to server.
        var args = {
            'url': '/restaurant/' + this.restaurant.business_id,
            'method': 'PATCH',
            'body': '{"rating": 3}'
        };
        this.$.xhr.request(args);
      },
      onResponse: function() {
        console.log("got server response");
      }
    });
  </script>
</polymer-element>
